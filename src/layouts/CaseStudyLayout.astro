---
// @ts-ignore
import { localizePath } from "astro-i18next";
import Layout from "./Layout.astro";
import BackLink from "../components/BackLink.astro";
import SideBar from "../components/SideBar.astro";
import Button from "../components/Button.astro";
import Badge from "../components/Badge.astro";
import {
  ReactIcon,
  TypeScriptIcon,
  NextjsIcon,
  NodejsIcon,
  TailwindIcon,
  AstroIcon,
  SvelteIcon,
  MongoDBIcon,
  FigmaIcon,
  PhotoshopIcon,
  ExpressIcon,
  EJSIcon,
  OpenAIIcon,
  CSS3DIcon,
  ViteIcon,
  NXLogo,
  ESBuildIcon,
} from "../utils/icons";
import Footer from "./Footer.astro";

interface Props {
  title: string;
  subtitle: string;
  pageTitle: string;
  sidebarItems: { text: string; href: string }[];
  projectRole: string[];
  team: string[];
  tools: string[];
  timeline: string[];
  demoLink?: string;
  githubLink?: string;
  sidebarClassName?: string;
  isCaseStudy?: boolean;
}

const {
  title,
  subtitle,
  pageTitle,
  sidebarItems,
  projectRole,
  team,
  tools,
  timeline,
  demoLink,
  githubLink,
  sidebarClassName = "fixed right-[calc((100vw-1150px)/2-7rem)] top-56",
  isCaseStudy = false,
}: Props = Astro.props;

function getToolIcon(toolName: string) {
  const normalizedName = toolName.toLowerCase().replace(/[.\s-]/g, "");
  const iconMap: Record<string, any> = {
    react: ReactIcon,
    typescript: TypeScriptIcon,
    nextjs: NextjsIcon,
    nodejs: NodejsIcon,
    tailwind: TailwindIcon,
    tailwindcss: TailwindIcon,
    astro: AstroIcon,
    svelte: SvelteIcon,
    mongodb: MongoDBIcon,
    figma: FigmaIcon,
    photoshop: PhotoshopIcon,
    express: ExpressIcon,
    ejs: EJSIcon,
    openaiapi: OpenAIIcon,
    openai: OpenAIIcon,
    css3d: CSS3DIcon,
    vite: ViteIcon,
    nx: NXLogo,
    nxjs: NXLogo,
    reacttela: ReactIcon,
    esbuild: ESBuildIcon,
  };
  return iconMap[normalizedName] || null;
}

function getToolUrl(toolName: string) {
  const normalizedName = toolName.toLowerCase().replace(/[.\s-]/g, "");
  const urlMap: Record<string, string> = {
    react: "https://react.dev/",
    typescript: "https://www.typescriptlang.org/",
    nextjs: "https://nextjs.org/",
    nodejs: "https://nodejs.org/",
    tailwind: "https://tailwindcss.com/",
    tailwindcss: "https://tailwindcss.com/",
    astro: "https://astro.build/",
    svelte: "https://svelte.dev/",
    mongodb: "https://www.mongodb.com/",
    figma: "https://www.figma.com/",
    photoshop: "https://www.adobe.com/products/photoshop.html",
    express: "https://expressjs.com/",
    ejs: "https://ejs.co/",
    openaiapi: "https://openai.com/api/",
    openai: "https://openai.com/api/",
    css3d: "https://www.w3schools.com/css/css3_3dtransforms.asp",
    vite: "https://vitejs.dev/",
    nx: "https://nxjs.n8.io/",
    nxjs: "https://nxjs.n8.io/",
    reacttela: "https://github.com/TooTallNate/react-tela",
    esbuild: "https://esbuild.github.io/",
  };
  return urlMap[normalizedName] || undefined;
}

// Determine which links to show based on isCaseStudy flag
const displayDemoLink = isCaseStudy ? undefined : demoLink;
const displayGithubLink = isCaseStudy ? undefined : githubLink;
---

<Layout title={pageTitle}>
  <div class="m-8">
    <BackLink label={"Back"} href={localizePath("/")} />
  </div>
  <main class="mx-auto flex w-[1150px] max-w-full flex-row">
    <SideBar navItems={sidebarItems} className={sidebarClassName} />
    <div class="mx-4 mb-20">
      <h1 class="mt-4 text-center text-5xl font-bold text-white">
        {title}
      </h1>
      <h2 class="mb-8 text-center text-[1rem] text-[#d0d0d0]">
        {subtitle}
      </h2>

      <!-- Hero slot for Book component or banner images -->
      <slot name="hero" />

      <!-- Project Description -->
      <div class="project-description-container">
        <div
          class="tools-and-buttons-container mx-14 my-6 flex flex-wrap items-center justify-between gap-4 max-lg:flex-col max-md:mx-4 max-md:items-center"
        >
          <div
            class=`tools-badges flex min-w-0 flex-1 flex-wrap gap-2 max-lg:justify-center max-md:w-full max-md:flex-1 max-md:justify-center ${(displayDemoLink || displayGithubLink) ?? "justify-center"}`
          >
            {
              tools.map((tool) => {
                const IconComponent = getToolIcon(tool);
                const toolUrl = getToolUrl(tool);
                return (
                  <Badge text={tool} href={toolUrl}>
                    {IconComponent ? (
                      <IconComponent />
                    ) : (
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="2rem"
                        height="2rem"
                        viewBox="0 0 24 24"
                      >
                        <path
                          fill="#e0e0e0"
                          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                        />
                      </svg>
                    )}
                  </Badge>
                );
              })
            }
          </div>
          {
            (displayDemoLink || displayGithubLink) && (
              <div class="buttons-container flex gap-4 max-md:justify-center">
                {displayGithubLink && (
                  <Button
                    href={displayGithubLink}
                    label="GitHub"
                    variant="secondary"
                    ariaLabel="View on GitHub"
                  >
                    <svg
                      slot="icon"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                    >
                      <path
                        fill="currentColor"
                        d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"
                      />
                    </svg>
                  </Button>
                )}
                {displayDemoLink && (
                  <Button
                    href={displayDemoLink}
                    label="Live Demo"
                    variant="primary"
                    ariaLabel="View Live Demo"
                  >
                    <svg
                      slot="icon"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                    >
                      <path
                        fill="currentColor"
                        d="M14 3v2h3.59l-9.83 9.83l1.41 1.41L19 6.41V10h2V3m-2 16H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2z"
                      />
                    </svg>
                  </Button>
                )}
              </div>
            )
          }
        </div>
        <div
          class="project-info-row mb-6 mt-6 flex w-full flex-row items-start justify-center gap-0 pt-4 sm:gap-6 md:mt-2"
        >
          <div
            class="info-block flex flex-1 shrink flex-col items-center px-2 py-2 text-center"
          >
            <div>
              <h2 class="font-semibold text-white">Role</h2>
            </div>
            <ul class="info-list list-none text-[#D0D0D0]">
              {projectRole.map((role) => <li>{role}</li>)}
            </ul>
          </div>
          <div class="divider hidden self-stretch sm:block" aria-hidden="true">
          </div>
          <div
            class="info-block flex flex-1 shrink flex-col items-center px-2 py-2 text-center"
          >
            <div>
              <h2 class="font-semibold text-white">Team</h2>
            </div>
            <ul class="info-list list-none text-[#D0D0D0]">
              {team.map((member) => <li>{member}</li>)}
            </ul>
          </div>
          <div class="divider hidden self-stretch sm:block" aria-hidden="true">
          </div>
          <div
            class="info-block flex flex-1 shrink flex-col items-center px-2 py-2 text-center"
          >
            <div>
              <h2 class="font-semibold text-white">Timeline</h2>
            </div>
            <ul class="info-list list-none text-[#D0D0D0]">
              {timeline.map((time) => <li>{time}</li>)}
            </ul>
          </div>
        </div>
      </div>

      <!-- Main content slots -->
      <slot />
    </div>
  </main>
  <Footer />
</Layout>

<style>
  /* Broken on Safari... disable for now */
  @supports (hanging-punctuation: first) and (font: -apple-system-body) and
    (-webkit-appearance: none) {
    .mockup-container,
    .mockup-content,
    .mockup-phone {
      display: none;
    }
  }

  .mockup-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    aspect-ratio: 9/16;
  }

  .mockup-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    height: auto;
    aspect-ratio: 9/16;
    overflow-y: auto;
    z-index: 1;
    scrollbar-width: none; /* Firefox */
  }

  .mockup-content::-webkit-scrollbar {
    display: none; /* Chrome, Safari and Opera */
  }

  .mockup-phone {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    z-index: 2;
    pointer-events: none;
    aspect-ratio: 9/16;
  }

  @media (max-width: 1024px) {
    .mockup-content {
      transform: translate(-155px, -50%);
    }
  }

  .text-link {
    color: var(--header-color);
    text-decoration: underline;
    text-decoration-color: var(--header-color);
    text-underline-offset: 2px;
    font-weight: 600;
    display: inline-block;
    position: relative;
  }

  @media (hover: hover) {
    .text-link {
      text-decoration: none;
    }
    .text-link:after {
      bottom: 0;
      content: "";
      height: 2px;
      left: 50%;
      position: absolute;
      background: var(--header-color);
      transition:
        width 0.2s ease 0s,
        left 0.2s ease 0s;
      width: 0;
    }
    .text-link:hover:after {
      width: 100%;
      left: 0;
    }
  }

  :global(.case-study-layout) h3,
  :global(.case-study-layout) h4,
  :global(.case-study-layout) h5,
  :global(.case-study-layout) h6,
  :global(.case-study-layout) p {
    margin: 0;
    text-align: left;
  }

  :global(.case-study-layout) h3 {
    margin-bottom: 1rem;
  }

  :global(.case-study-layout) li {
    color: #d0d0d0;
    list-style-type: disc;
    margin-left: 1.25rem;
    padding: 0.25rem;
  }

  :global(.case-study-layout) iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  :global(.case-study-layout) section {
    padding: 2rem;
  }

  :global(.case-study-layout) h2 {
    margin-bottom: 1rem;
  }

  :global(.case-study-layout) p {
    line-height: 1.6;
    color: var(--text-color);
  }

  @media (max-width: 1000px) {
    main {
      flex-direction: column;
      width: 100%;
    }

    :global(.sidebar) {
      display: none;
    }
  }

  :global(.case-study-layout) .card-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: space-between;
  }

  :global(.case-study-layout) .card {
    background-color: var(--card-color);
    border: 1px solid #333;
    border-radius: 0.75rem;
    padding: 1.5rem;
    width: calc(33.33% - 0.67rem);
    margin-bottom: 1rem;
  }

  :global(.case-study-layout) .card h4 {
    margin-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    :global(.case-study-layout) .card {
      width: 100%;
    }
  }

  :global(.case-study-layout) .row-card-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  :global(.case-study-layout) .row-card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background-color: var(--card-color);
    border: 1px solid #333;
    border-radius: 0.75rem;
    padding: 1rem;
    width: 100%;
    margin-bottom: 1rem;
  }

  :global(.case-study-layout) code {
    background-color: #2d2d2d;
    color: #f8f8f2;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: "Courier New", Courier, monospace;
  }

  :global(.case-study-layout) pre {
    background-color: #1e1e1e;
    color: #d4d4d4;
    padding: 1rem;
    border-radius: 8px;
    overflow: auto;
    text-align: left;
    white-space: pre-wrap;
    word-break: break-word;
  }

  :global(.case-study-layout) .fade-in {
    opacity: 0;
    transition: opacity 0.5s ease-out;
  }

  :global(.case-study-layout) .fade-in.visible {
    opacity: 1;
  }

  .project-description-container {
    width: 100%;
  }

  @media (min-width: 640px) and (max-width: 767px) {
    .project-info-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .project-info-grid > div:nth-child(3) {
      grid-column: 1 / -1;
      justify-self: center;
      max-width: fit-content;
    }
  }

  .divider {
    width: 1px;
    background: linear-gradient(to bottom, #c9c9c980 0, #59595980 100%);
    margin: 0 0.5rem;
    min-height: 3.5rem;
    align-self: stretch;
  }

  .project-info-row .info-block,
  .project-info-row .info-list,
  .project-info-row h2 {
    font-size: clamp(0.6rem, 2vw, 1rem);
  }

  @media (max-width: 500px) {
    .project-info-row {
      flex-direction: column;
      align-items: stretch;
      gap: 0;
    }
    .project-info-row .divider {
      display: none !important;
    }
    .project-info-row .info-block,
    .project-info-row .info-list,
    .project-info-row h2 {
      font-size: 1rem !important;
    }
    .project-info-row .info-block {
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
    .project-info-row .info-block:not(:last-child) {
      border-bottom: 1.5px solid #80808038;
      margin-bottom: 0;
      padding-bottom: 2rem;
    }
    .project-info-row .info-block:first-child {
      padding-top: 1rem;
    }
  }
</style>
